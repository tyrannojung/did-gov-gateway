# DID Government Gateway

This is the gateway service for managing DIDs, VCs, and VPs on Hyperledger Fabric.

## Setup

### 1. Install Dependencies
```bash
pnpm install
```

### 2. Deploy Chaincode
```bash
# From test-network directory
./network.sh up createChannel -c mychannel -ca -s couchdb

# Deploy with simplified endorsement policy for testing
./network.sh deployCC -c mychannel -ccn anamdid \
  -ccp ../did-fabric-contract -ccl javascript -ccs 1 \
  -ccep "OR('Org1MSP.peer')"
```

### 3. Configure Environment
```bash
# Copy .env.example to .env and update Fabric paths
cp .env.example .env
# Edit .env to update FABRIC_* paths with your actual paths
```

### 4. Setup Issuer
```bash
# This will generate issuer keys and register issuer DID on chain
pnpm setup:issuer
```

### 5. Start Server
```bash
pnpm dev   # Development mode with auto-reload
# or
pnpm start # Production mode
# Server will run on port 8081
```

## API Endpoints

### DID Management

#### `POST /dids/user` - Register user DID
**Request Body:**
```json
{
  "publicKey": "-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----",  // required - PEM format
  "additionalInfo": {  // optional
    "name": "Hong Gildong"
  }
}
```
**Response (201):** 
```json
{
  "userId": "2mFqX7Z5whEMAKjc9SwF3BRw",
  "did": "did:anam145:user:2mFqX7Z5whEMAKjc9SwF3BRw"
}
```

#### `GET /dids/:did` - Get DID document
**Parameters:**
- `did`: Full DID string (e.g., `did:anam145:user:2mFqX7Z5whEMAKjc9SwF3BRw`)

**Response (200):** Returns DID Document (see DID.example.md)

### License Management

#### `POST /licenses` - Create license DID and issue VC
**Request Body:**
```json
{
  "userDid": "did:anam145:user:2mFqX7Z5whEMAKjc9SwF3BRw",  // required
  "licenseNumber": "서울-01-123456"  // optional, default: "11-22-33-44"
}
```
**Response (200):**
```json
{
  "licenseDid": "did:anam145:license:3nGrY8a6xiDNBLkd0TyG4CSx",
  "userDid": "did:anam145:user:2mFqX7Z5whEMAKjc9SwF3BRw",
  "licenseNumber": "서울-01-123456",
  "vc": { /* DriverLicenseVC object */ }
}
```

#### `GET /licenses/:licenseId` - Get license DID document
**Parameters:**
- `licenseId`: License ID only (e.g., `45s3FPxvFRdgdbwkWNdjCwxtUg51`)
- ⚠️ NOT the full DID

**Response (200):** Returns License DID Document

### Student Card Management

#### `POST /students` - Create student DID and issue VC
**Request Body:**
```json
{
  "userDid": "did:anam145:user:2mFqX7Z5whEMAKjc9SwF3BRw",  // required
  "studentNumber": "2023572504",  // optional, default: "2023000000"
  "university": "Korea University",  // optional, default: "Korea University"
  "department": "Graduate School of Information Security"  // optional, default: "Graduate School of Information Security"
}
```
**Response (200):**
```json
{
  "studentDid": "did:anam145:student:3nGrY8a6xiDNBLkd0TyG4CSx",
  "userDid": "did:anam145:user:2mFqX7Z5whEMAKjc9SwF3BRw",
  "vc": { /* StudentCardVC object */ }
}
```

#### `GET /students/:studentId` - Get student DID document
**Parameters:**
- `studentId`: Student ID only (e.g., `3nGrY8a6xiDNBLkd0TyG4CSx`)
- ⚠️ NOT the full DID

**Response (200):** Returns Student DID Document

### VC Management

#### `GET /vcs/:vcId` - Get specific VC
**Parameters:**
- `vcId`: VC ID (e.g., `4oHsZ9b7yjEPCMle1UzH5DTy`)

**Response (200):** Returns VC object (see DID.example.md)

#### `GET /vcs/:vcId/verify` - Verify VC on chain
**Parameters:**
- `vcId`: VC ID to verify

**Response (200):**
```json
{
  "valid": true,
  "reason": "VC가 유효합니다."
}
```

### VP Management

#### `POST /vps/verify` - Verify VP
**Request Body:**
```json
{
  "challenge": "random-challenge-string-12345",  // required
  "vp": {  // required - VP created by client
    "@context": ["https://www.w3.org/ns/credentials/v2"],
    "type": ["VerifiablePresentation"],
    "holder": "did:anam145:user:2mFqX7Z5whEMAKjc9SwF3BRw",
    "verifiableCredential": { /* Single VC object */ },
    "proof": {
      "type": "Secp256r1Signature2018",
      "created": "2024-01-15T10:35:00.000Z",
      "verificationMethod": "did:anam145:user:2mFqX7Z5whEMAKjc9SwF3BRw#keys-1",
      "proofPurpose": "authentication",
      "challenge": "random-challenge-string-12345",
      "proofValue": "MEYCIQCx..."  // Signed by holder's private key
    }
  }
}
```
**Response (200):**
```json
{
  "valid": true,
  "reason": "VP valid"
}
```

**Notes:**
- Only single VC in VP is supported (not arrays)
- Android clients must escape slashes when stringifying JSON
- Challenge must be unique for each verification

## Environment Variables

See `.env.example` for all required environment variables. The key variables include:
- `PORT` - Server port (default: 8081)
- `FABRIC_*` - Fabric connection credentials
- `ISSUER_ID` and `ISSUER_DID` - Auto-generated by pnpm setup:issuer
- `CHAINCODE_NAME` - Chaincode name (anamdid)

## API Usage Examples

### 1. Register User DID
```bash
# First, create user with public key
curl -X POST http://localhost:8081/dids/user \
  -H "Content-Type: application/json" \
  -d '{
    "publicKey": "-----BEGIN PUBLIC KEY-----\nMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE...\n-----END PUBLIC KEY-----",
    "additionalInfo": { "name": "Hong Gildong" }
  }'
```

### 2. Create Driver License
```bash
curl -X POST http://localhost:8081/licenses \
  -H "Content-Type: application/json" \
  -d '{
    "userDid": "did:anam145:user:2mFqX7Z5whEMAKjc9SwF3BRw",
    "licenseNumber": "서울-01-123456"
  }'
```

### 3. Create Student Card
```bash
curl -X POST http://localhost:8081/students \
  -H "Content-Type: application/json" \
  -d '{
    "userDid": "did:anam145:user:2mFqX7Z5whEMAKjc9SwF3BRw",
    "studentNumber": "2023572504",
    "university": "Korea University",
    "department": "Graduate School of Information Security"
  }'
```

### 4. Verify VP (Client creates VP, Server verifies)
```bash
curl -X POST http://localhost:8081/vps/verify \
  -H "Content-Type: application/json" \
  -d '{
    "challenge": "random-challenge-12345",
    "vp": {
      "@context": ["https://www.w3.org/ns/credentials/v2"],
      "type": ["VerifiablePresentation"],
      "holder": "did:anam145:user:2mFqX7Z5whEMAKjc9SwF3BRw",
      "verifiableCredential": { /* VC object */ },
      "proof": { /* VP proof signed by holder */ }
    }
  }'
```

## Multiple VCs Support

A single user can have multiple VCs (Verifiable Credentials):
- Driver License VC (type: "DriverLicenseVC")
- Student Card VC (type: "StudentCardVC")
- And more can be added in the future

When creating a VP (Verifiable Presentation), users can include one or more VCs as needed.

## Security Notes

- The `src/storage/` directory contains private keys and is gitignored
- Never commit wallet files or private keys
- Always use HTTPS in production